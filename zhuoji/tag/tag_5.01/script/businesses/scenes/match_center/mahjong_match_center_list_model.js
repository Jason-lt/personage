/*****************************************
 *  mahjong_match_center_list_model.js
    (发牌)牌桌相关model
 *  mahjong
 *
 *  Created by nick.kai.lee on 16-09-05
 *  
    协议说明：
    {"cmd":"user","result":{"action":"match_room_list","gameId":7,"userId":10001,"tabs":["all","hot","free"],"rooms":[{"start_ts":1473069660,"room_id":73521000,"match_state":0,"matchInstId":"7352.2199","match_type":3,"players":[4,1000],"title":"疯狂2万金币赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":400,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473069780,"room_id":73541000,"match_state":0,"matchInstId":"7354.1887","match_type":3,"players":[4,1000],"title":"血流1元话费赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"sichuan_xlch","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473069900,"room_id":73511000,"match_state":0,"matchInstId":"7351.1888","match_type":3,"players":[2,5000],"title":"二人1元话费赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao2ren","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":150,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473070020,"room_id":73501000,"match_state":0,"matchInstId":"7350.333","match_type":3,"players":[4,5000],"title":"疯狂1元话费赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473070080,"room_id":73571000,"match_state":0,"matchInstId":"7357.2201","match_type":3,"players":[2,5000],"title":"二人2万金币赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao2ren","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":150,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473070140,"room_id":73531000,"match_state":0,"matchInstId":"7353.2201","match_type":3,"players":[4,1000],"title":"血流2万金币赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"sichuan_xlch","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":400,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473073200,"room_id":73611000,"match_state":0,"matchInstId":"7361.14","match_type":3,"players":[4,5000],"title":"100元免费赛","desc":"经典国标玩法，冠军独享7000奖券","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473076800,"room_id":73641000,"match_state":0,"matchInstId":"7364.14","match_type":3,"players":[2,5000],"title":"二人金币免费赛","desc":"每日20点整，冠军独享100万金币","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao2ren","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":150,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473080400,"room_id":73621000,"match_state":0,"matchInstId":"7362.14","match_type":3,"players":[4,5000],"title":"100元免费赛","desc":"经典国标玩法，冠军独享7000奖券","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473084000,"room_id":73651000,"match_state":0,"matchInstId":"7365.14","match_type":3,"players":[4,5000],"title":"血流金币免费赛","desc":"每日22点整，冠军独享100万金币","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"sichuan_xlch","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":200,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473087600,"room_id":73631000,"match_state":0,"matchInstId":"7363.14","match_type":3,"players":[4,5000],"title":"100元免费赛","desc":"经典国标玩法，冠军独享7000奖券","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473135600,"room_id":73551000,"match_state":0,"matchInstId":"7355.4","match_type":3,"players":[2,5000],"title":"10元二人赛","desc":"每日12:20，新赛制免费体验","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao2ren","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":150,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},{"start_ts":1473139200,"room_id":73561000,"match_state":0,"matchInstId":"7356.4","match_type":3,"players":[4,5000],"title":"10元血流赛","desc":"每日13点，前60名有奖，冠军独享10元","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"sichuan_xlch","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":200,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0}]}};
    {"cmd":"user","result":{"action":"majiang_match_info","gameId":7,"userId":10001,"room_id":73521000,"start_ts":1473132660,"matchInstId":"7352.2328","match_state":0,"hasSignined":0}}
    使用说明:

 */

(function () {
    var GLOBAL_OBJ = guiyang;

    GLOBAL_OBJ.businesses.scenes.Match.Models.List = (function(){
        /*
         私有数据+接口
         TODO:
         数据的原型，存储以及通知的抛出
         */

        /* @数据缓存*/
        var CACHE               = {
            rooms:{},
            rewards:{},
        };

        /* @数据通知*/
        var ___f_notificate00   = function(_object, _data, _slient){
            if (GLOBAL_OBJ.bkernel.Functions.isEmptyObject(_data) == true){
                return _slient;
            }

            var data            = _data;

            //3个标签类别
            CACHE.rooms["all"]  = [];
            CACHE.rooms["free"] = [];
            CACHE.rooms["hot"]  = [];

            //分类存储
            for(var i in _data.rooms){
                for(var j in _data.rooms[i].tab){
                    CACHE.rooms[ _data.rooms[i].tab[j] ].push( _data.rooms[i] );
                }
            }

            //根据开赛时间排序
            for(var type in CACHE.rooms){
                CACHE.rooms[ type ].sort(function(a, b){
                    return a.start_ts > b.start_ts && a.list_level >= b.list_level;
                });
            }


            if (!_slient){
                GLOBAL_OBJ.bkernel.utils.Notification.trigger( GLOBAL_OBJ.businesses.Events.UPDATE_MATCH_CENTER_LIST_INFO, data);
            }
            return _slient
        };

        var ___f_notificate01   = function(_object, _data, _slient){
            if (GLOBAL_OBJ.bkernel.Functions.isEmptyObject(_data) == true){
                return _slient;
            }

            var data             = _data;
            var rooms            = CACHE.rooms["all"] || [];
            for(var i in rooms){
                if (data.room_id == rooms[i].room_id) {
                    rooms[i].start_ts    = data.start_ts;
                    rooms[i].hasSignined = data.hasSignined;
                    rooms[i].match_state = data.match_state;
                    break;
                }
            }

            //根据开赛时间排序
            for(var type in CACHE.rooms){
                CACHE.rooms[ type ].sort(function(a, b){
                    return a.start_ts > b.start_ts && a.list_level >= b.list_level;
                });
            }


            if (!_slient){
                GLOBAL_OBJ.bkernel.utils.Notification.trigger( GLOBAL_OBJ.businesses.Events.UPDATE_MATCH_CENTER_LIST_INFO, data);
            }
            return _slient
        };

        var ___f_notificate02   = function(_object, _data, _slient){
            if (GLOBAL_OBJ.bkernel.Functions.isEmptyObject(_data) == true){
                return _slient;
            }

            var data             = _data;
            var rooms            = CACHE.rooms["all"] || [];
            for(var i in rooms){
                if (data.roomId == rooms[i].room_id) {
                    rooms[i].nowPlayer = data.curPlayer;
                    break;
                }
            }

            if (!_slient){
                GLOBAL_OBJ.bkernel.utils.Notification.trigger( GLOBAL_OBJ.businesses.Events.UPDATE_MATCH_CENTER_ONLINES_INFO, data);
            }
            return _slient
        };

        var ___f_notificate03   = function(_object, _data, _slient){
            if (GLOBAL_OBJ.bkernel.Functions.isEmptyObject(_data) == true){
                return _slient;
            }

            var data                   = _data;
            CACHE.rewards[data.room_id] = data.award_list || [];

            if (!_slient){
                GLOBAL_OBJ.bkernel.utils.Notification.trigger( GLOBAL_OBJ.businesses.Events.UPDATE_MATCH_CENTER_REWARDS_INFO, data);
            }
            return _slient
        };

        return {
            _TAG:"businesses.scenes.Match.Models.List",

            /*
             公有数据+接口
             TODO:
             外部调用
             */
            /* 协议解析*/
            parse:function(_data, _slient){
                var data = _data;
                var action = data["action"];
                if (!data){
                    return;
                }
                switch(action){
                    case "match_room_list": //全量房间信息
                        return ___f_notificate00(this, data, _slient);
                    case "majiang_match_info": //单条房间信息更新
                        return ___f_notificate01(this, data, _slient);
                    case "m_update": // 房间人数刷新
                        return ___f_notificate02(this, data, _slient);
                    case "match_reward_list": // 比赛奖励
                        return ___f_notificate03(this, data, _slient);
                }
            },

            /*
             激活model，发送一次数据
             返回值：false数据为空 */
            activate:function(){
                return false;
            },

            /*
             获得类型比赛场次*/
            getMatchCountByType:function(_type){
                return CACHE.rooms[_type] ? CACHE.rooms[_type].length:0;
            },

            getMatchName:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.title || "";
            },

            getMatchRoomId:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.room_id || "";
            },

            /*
             比赛话费类型：1 金币赛 2 积分赛*/
            getMatchFeeType:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.anteType || 1;
            },

            /*
             比赛时长 单位：s*/
            getMatchTimeSpend:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.continue_time || 0;
            },

            /*
             比赛当前在线人数（报名人数） */
            getMatchOnlines:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.nowPlayer || 0;
            },

            /*
             比赛玩法类型 */
            getMatchMode:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.play_mode || GLOBAL_OBJ.businesses.global.PLAYMODE.CRAZY;
            },

            /*
             比赛句柄 */
            getMatchInstance:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.matchInstId || 0;
            },

            /*
             比赛开始时间戳 */
            getMatchBeginTimestamp:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.start_ts || 0;
            },

            /*
             比赛类型 1 麻将老比赛, 2 麻将sng,3 麻将mtt*/
            getMatchType:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.match_type || 1;
            },

            /*
             比赛奖励信息*/
            getMatchRewards:function(_roomId){
                var rewards = CACHE.rewards[_roomId] || [];
                return rewards;
            },


            /*       新比赛         */
            /*
             是否已经报名比赛状态 new*/
            getMatchSignInState:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.hasSignined == 1 ? true : false;
            },

            /*
             比赛报名条件 new*/
            getMatchSignInCondition:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                var fees  = room.fees || [];
                var cond  = "";
                var num   = 0;
                for(var i in fees){
                    cond  = cond + fees[i].name + (fees[i].num >= 100000 ? (fees[i].num/10000)+"万" : fees[i].num) + " "
                }
                return fees.length > 0 ? cond : "免费";
            },

            /*       老比赛         */
            /*
             是否已经参加比赛状态 old*/
            getMatchJointState:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.played == 1 ? true : false;
            },

            /*
             比赛准入条件 old*/
            getMatchJointCondition:function(_type, _index){
                var rooms = CACHE.rooms[_type] || [];
                var room  = rooms[_index] || {};
                return room.ticket || "";
            },

            /*
             测试用例
             TODO:
             model测试用例
             */
            test:function(_index){
                var cmds = {};
                switch(_index){
                    case 0:
                        cmds = {"cmd":"user",
                            "result":
                            {
                                "action":"match_room_list","gameId":715,"userId":10034,
                                "tabs":["all","hot","free"],
                                "rooms":[
                                    {"start_ts":1473069660,"room_id":73521000,"match_state":0,"matchInstId":"7352.2199","match_type":3,"players":[4,1000],"title":"疯狂2万金币赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":400,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473069780,"room_id":73541000,"match_state":0,"matchInstId":"7354.1887","match_type":3,"players":[4,1000],"title":"血流1元话费赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"sichuan_xlch","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473069900,"room_id":73511000,"match_state":0,"matchInstId":"7351.1888","match_type":3,"players":[2,5000],"title":"二人1元话费赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao2ren","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":150,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473070020,"room_id":73501000,"match_state":0,"matchInstId":"7350.333","match_type":3,"players":[4,5000],"title":"疯狂1元话费赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473070080,"room_id":73571000,"match_state":0,"matchInstId":"7357.2201","match_type":3,"players":[2,5000],"title":"二人2万金币赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao2ren","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":150,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473070140,"room_id":73531000,"match_state":0,"matchInstId":"7353.2201","match_type":3,"players":[4,1000],"title":"血流2万金币赛","desc":"每1分钟一场免费报名，前128名有奖","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"sichuan_xlch","tab":["all","free"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":400,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473073200,"room_id":73611000,"match_state":0,"matchInstId":"7361.14","match_type":3,"players":[4,5000],"title":"100元免费赛","desc":"经典国标玩法，冠军独享7000奖券","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473076800,"room_id":73641000,"match_state":0,"matchInstId":"7364.14","match_type":3,"players":[2,5000],"title":"二人金币免费赛","desc":"每日20点整，冠军独享100万金币","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao2ren","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":150,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473080400,"room_id":73621000,"match_state":0,"matchInstId":"7362.14","match_type":3,"players":[4,5000],"title":"100元免费赛","desc":"经典国标玩法，冠军独享7000奖券","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473084000,"room_id":73651000,"match_state":0,"matchInstId":"7365.14","match_type":3,"players":[4,5000],"title":"血流金币免费赛","desc":"每日22点整，冠军独享100万金币","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"sichuan_xlch","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":200,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473087600,"room_id":73631000,"match_state":0,"matchInstId":"7363.14","match_type":3,"players":[4,5000],"title":"100元免费赛","desc":"经典国标玩法，冠军独享7000奖券","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":300,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473135600,"room_id":73551000,"match_state":0,"matchInstId":"7355.4","match_type":3,"players":[2,5000],"title":"10元二人赛","desc":"每日12:20，新赛制免费体验","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"guobiao2ren","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":150,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0},
                                    {"start_ts":1473139200,"room_id":73561000,"match_state":0,"matchInstId":"7356.4","match_type":3,"players":[4,5000],"title":"10元血流赛","desc":"每日13点，前60名有奖，冠军独享10元","purl":"","signinCd":0,"nowPlayer":0,"fees":[],"hasSignined":0,"play_mode":"sichuan_xlch","tab":["all","free","hot"],"anteType":2,"min_coin":10000,"max_coin":-1,"base_chip":200,"service_fee":0,"continue_time":7200,"req_interval":6,"refresh_list":1,"list_level":0}
                                ]
                            }
                        };

                        break;
                }
                ty.netMsgDispatcher.processMsg(cmds.cmd, [cmds]);
            }
        };
    })();
})();

